---
layout: post
title:  "How to integrate unit test framework in cmake"
lang: en
ref: cmake_catch
date:   2016-05-13 21:24:29 +0800
categories: cmake test
---
<p>
I am trying to make my project to include two part: the sources (in <code>src</code> subfolder) and tests (in <code>test</code> subfolder). I am using <a href="https://cmake.org/">CMake</a> to build this, if you have never used cmake before and do not want use it recently, just press <code>Ctrl/Cmd+W</code> and then do whatever not wast your precious time. 
</p>

<p>
The test framework I choose is <a href="https://github.com/philsquared/Catch">Catch</a>. However, the process of using different framework like CppUnit, Boost Test Library or googletest should be very similar.
</p>

<p>
Generally, I add all source code except main.cpp into a library called <code>CommonSourceCode</code> and link it both by the production program and the test.
</p>

<p>
CMakeLists.txt
</p>
<div class="org-src-container">

<pre class="src src-cmake">cmake_minimum_required (VERSION 2.8) 
project (MyAwesomeProject) 

...

add_subdirectory (src)

...

add_library (CommonSourceCode ${SRC_LIST})
add_executable(MyAwesomeProject src/main.cpp)
target_link_libraries (MyAwesomeProject CommonSourceCode)

add_subdirectory (test)
</pre>
</div>

<p>
src/CMakeLists.txt
</p>
<div class="org-src-container">

<pre class="src src-cmake">set(SRC_LIST ${SRC_LIST} a.hpp a.cpp b.hpp PARENT_SCOPE)
</pre>
</div>
<p>
Notice the <code>PARENT_SCOPE</code> because I do not build the executable in this folder.
</p>

<p>
I then use the script from Catch's <a href="https://github.com/philsquared/Catch/blob/master/docs/build-systems.md">document</a> to automatically fetch it from github and configure it as an <a href="https://cmake.org/cmake/help/v3.4/module/ExternalProject.html">external project</a>:
</p>

<p>
test/CMakeLists.txt
</p>
<div class="org-src-container">

<pre class="src src-cmake">include(ExternalProject)
find_package(Git REQUIRED)

ExternalProject_Add(
    catch
    PREFIX ${CMAKE_BINARY_DIR}/test/catch
    GIT_REPOSITORY https://github.com/philsquared/Catch.git
    TIMEOUT 10
    UPDATE_COMMAND ${GIT_EXECUTABLE} pull
    CONFIGURE_COMMAND ""
    BUILD_COMMAND ""
    INSTALL_COMMAND ""
    LOG_DOWNLOAD ON
   )

# Expose required variable (CATCH_INCLUDE_DIR) to parent scope
ExternalProject_Get_Property(catch source_dir)
set(CATCH_INCLUDE_DIR ${source_dir}/include CACHE INTERNAL "Path to include folder for Catch")

add_library(Catch INTERFACE)
target_include_directories(Catch INTERFACE ${CATCH_INCLUDE_DIR})

add_executable (test testmain.cpp testA.cpp testB.cpp)
target_link_libraries(Test Catch CommonSourceCode)

add_test (NAME MyTest COMMAND Test)
</pre>
</div>
<p>
Certainly, I omit part contents in my CMakeFiles like c++11 support. But the idea is here.</p>
