---
layout: post
title:  "如何在cmake中嵌入单元测试框架"
lang: zh
ref: cmake_catch
date:   2016-05-14 09:43:00 +0800
categories: cmake test
---
<p>
工程的目录结构会有两部分：源文件（在 <code>src</code> 子文件夹中）以及测试(在 <code>test</code> 子文件夹中)。我使用<a href="https://cmake.org/">CMake</a>来构建这个工程。如果您从没用使用过cmake并且不打算在近期使用它，请直接按 <code>Ctrl/Cmd+W</code> 。
</p>

<p>
我选择的测试框架是<a href="https://github.com/philsquared/Catch">Catch</a>，不过选择其他诸如CppUnit、Boost Test Library、googletest的框架的流程应该差不多。
</p>

<p>
首先， 我把除了 <code>main.cpp</code> 以外的所有源代码构建到一个叫做 <code>CommonSourceCode</code> 的库中，并且同时在主程序和测试程序中链接这个库。
</p>

<p>
CMakeLists.txt
</p>
<div class="org-src-container">

<pre class="src src-cmake">cmake_minimum_required (VERSION 2.8) 
project (MyAwesomeProject) 

...

add_subdirectory (src)

...

add_library (CommonSourceCode ${SRC_LIST})
add_executable(MyAwesomeProject src/main.cpp)
target_link_libraries (MyAwesomeProject CommonSourceCode)

add_subdirectory (test)
</pre>
</div>

<p>
src/CMakeLists.txt
</p>
<div class="org-src-container">

<pre class="src src-cmake">set(SRC_LIST ${SRC_LIST} a.hpp a.cpp b.hpp PARENT_SCOPE)
</pre>
</div>
<p>
注意这里我加入的 <code>PARENT_SCOPE</code> ，因为我没有打算在这个目录构建可执行程序。
</p>

<p>
我使用Catch的<a href="https://github.com/philsquared/Catch/blob/master/docs/build-systems.md">文档</a>中的脚本来自动从github上获取我使用Catch，并把它设置成一个<a href="https://cmake.org/cmake/help/v3.4/module/ExternalProject.html">external project</a>：
</p>

<p>
test/CMakeLists.txt
</p>
<div class="org-src-container">

<pre class="src src-cmake">include(ExternalProject)
find_package(Git REQUIRED)

ExternalProject_Add(
    catch
    PREFIX ${CMAKE_BINARY_DIR}/test/catch
    GIT_REPOSITORY https://github.com/philsquared/Catch.git
    TIMEOUT 10
    UPDATE_COMMAND ${GIT_EXECUTABLE} pull
    CONFIGURE_COMMAND ""
    BUILD_COMMAND ""
    INSTALL_COMMAND ""
    LOG_DOWNLOAD ON
   )

# Expose required variable (CATCH_INCLUDE_DIR) to parent scope
ExternalProject_Get_Property(catch source_dir)
set(CATCH_INCLUDE_DIR ${source_dir}/include CACHE INTERNAL "Path to include folder for Catch")

add_library(Catch INTERFACE)
target_include_directories(Catch INTERFACE ${CATCH_INCLUDE_DIR})

add_executable (Test testmain.cpp testA.cpp testB.cpp)
target_link_libraries(Test Catch CommonSourceCode)

add_test (NAME MyTest COMMAND Test)
</pre>
</div>
<p>
我省略了我的几个CMakeFile中包括c++11支持在内的部分内容，因为它们和我这里讲的东西没有关系。</p>
